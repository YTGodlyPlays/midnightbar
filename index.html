<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Immortal's ‚Äì Drink Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  >

  <style>
    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #ff4b8a15, transparent 55%),
        radial-gradient(circle at bottom right, #00e5ff20, transparent 55%),
        #050510;
      color: #f8f9fa;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .glass {
      background: #070814dd;
      border-radius: 1rem;
      border: 1px solid #ffffff20;
      box-shadow: 0 18px 40px rgba(0,0,0,.65);
      backdrop-filter: blur(14px);
    }

    .drink-card {
      transition: transform .12s ease-out, box-shadow .12s ease-out, border-color .12s ease-out;
      cursor: default;
    }

    .drink-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(0,0,0,.75);
      border-color: #0d6efd80;
    }

    .caps {
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: .78rem;
      color: #adb5bd;
    }

    .badge-pill {
      border-radius: 999px;
    }

    .stat-pill {
      min-width: 2.3rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 0.25rem 0.6rem;
    }

    .pill-a { background-color: #dc3545; color: #ffffff; }
    .pill-b { background-color: #ffc107; color: #212529; }
    .pill-d { background-color: #0dcaf0; color: #212529; }
    .pill-f { background-color: #198754; color: #ffffff; }
    .pill-k {
      background-color: #f8f9fa;
      color: #212529;
      border: 1px solid #ffffff55;
    }

    .stat-label {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      opacity: .8;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: .15em;
      text-transform: uppercase;
      font-size: .85rem;
      color: #adb5bd;
    }

    .result-count {
      font-size: .85rem;
      color: #adb5bd;
    }

    a.badge:hover {
      filter: brightness(1.1);
    }

    .sort-wrapper {
      background: #050711b3;
      border-radius: 999px;
      padding: 0.4rem 0.75rem;
      border: 1px solid #ffffff20;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .sort-dropdown {
      position: relative;
      min-width: 180px;
    }

    .sort-dropdown-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      width: 100%;
      border-radius: 999px;
      border: 1px solid #495057;
      background: #0b0e1e;
      color: #f8f9fa;
      padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .sort-dropdown-toggle:focus {
      outline: none;
      box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.4);
      border-color: #0d6efd;
    }

    .sort-dropdown-label-main {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      overflow: hidden;
    }

    .sort-label-prefix {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #adb5bd;
    }

    #sort-current-label {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: 0.8rem;
    }

    .sort-chevron {
      font-size: 0.75rem;
      opacity: 0.8;
      transform-origin: center;
      transition: transform 0.12s ease-out, opacity 0.12s;
    }

    .sort-dropdown.open .sort-chevron {
      transform: rotate(180deg);
      opacity: 1;
    }

    .sort-dropdown-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 0.25rem);
      min-width: 200px;
      background: #050713f5;
      border-radius: 0.75rem;
      border: 1px solid #ffffff30;
      box-shadow: 0 18px 30px rgba(0,0,0,0.7);
      padding: 0.35rem 0;
      z-index: 20;
      display: none;
      backdrop-filter: blur(12px);
    }

    .sort-dropdown.open .sort-dropdown-menu {
      display: block;
    }

    .sort-option {
      width: 100%;
      background: transparent;
      border: 0;
      color: #f8f9fa;
      padding: 0.35rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      text-align: left;
      cursor: pointer;
    }

    .sort-option:hover {
      background: #ffffff10;
    }

    .sort-option.active {
      background: #0d6efd33;
    }

    .sort-option-label-main {
      display: flex;
      flex-direction: column;
    }

    .sort-option-title {
      font-weight: 500;
    }

    .sort-option-sub {
      font-size: 0.7rem;
      color: #adb5bd;
    }

    .color-dot {
      width: 0.8rem;
      height: 0.8rem;
      border-radius: 999px;
      flex-shrink: 0;
      border: 1px solid #00000066;
    }

    .color-dot.default { background: #adb5bd; }
    .color-dot.a       { background: #dc3545; }
    .color-dot.b       { background: #ffc107; }
    .color-dot.d       { background: #0dcaf0; }
    .color-dot.f       { background: #198754; }
    .color-dot.k       {
      background: #f8f9fa;
      border-color: #adb5bd;
    }

    .sort-toggle .btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border-width: 1px;
    }

    .sort-toggle .btn.active {
      background-color: #0d6efd;
      color: #f8f9fa;
      border-color: #0d6efd;
    }

    .sort-toggle .btn:not(.active) {
      background-color: transparent;
      color: #ced4da;
      border-color: #495057;
    }

    .sort-toggle .btn:not(.active):hover {
      border-color: #adb5bd;
      color: #f8f9fa;
    }

    @media (max-width: 576px) {
      .sort-wrapper {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
<div class="container py-4 py-md-5">
  <div class="mx-auto mb-4 glass p-3 p-md-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <div class="brand-title mb-1">Info from Stella's Drinktionary</div>
        <h1 class="h3 mb-1 fw-semibold">Immortal's ‚Äì Drink Search</h1>
        <p class="mb-0 text-secondary">
          Start typing a drink name ‚Äì results update live.
        </p>
      </div>
      <form class="w-100 w-md-50" onsubmit="return false;">
        <div class="input-group input-group-lg shadow-sm">
          <span class="input-group-text bg-dark border-secondary text-secondary">üîç</span>
          <input
            id="search-input"
            type="text"
            class="form-control bg-dark border-secondary text-light"
            autocomplete="off"
            placeholder="Search for &quot;Abyssal Hug&quot;‚Ä¶">
        </div>
        <div class="form-text text-light mt-2">
          Quick picks are below if you forget a name.
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
    <div class="caps">
      Results
      <span id="query-label" class="text-secondary"></span>
    </div>

    <div class="sort-wrapper">
      <div class="sort-dropdown" id="sort-dropdown">
        <button type="button" class="sort-dropdown-toggle" id="sort-dropdown-toggle">
          <div class="sort-dropdown-label-main">
            <span class="sort-label-prefix">Sort</span>
            <span id="sort-current-label">Default (A ‚Üí Z)</span>
          </div>
          <span class="sort-chevron">‚ñæ</span>
        </button>
        <div class="sort-dropdown-menu" id="sort-menu">
          <button class="sort-option active" data-key="name" data-label="Default (A ‚Üí Z)">
            <span class="color-dot default"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">Default (A ‚Üí Z)</span>
              <span class="sort-option-sub">Name alphabetically</span>
            </span>
          </button>
          <button class="sort-option" data-key="k" data-label="K">
            <span class="color-dot k"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">K</span>
              <span class="sort-option-sub">Karmotrine</span>
            </span>
          </button>
          <button class="sort-option" data-key="a" data-label="A">
            <span class="color-dot a"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">A</span>
              <span class="sort-option-sub">Adelhype</span>
            </span>
          </button>
          <button class="sort-option" data-key="b" data-label="B">
            <span class="color-dot b"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">B</span>
              <span class="sort-option-sub">Bronson Ext</span>
            </span>
          </button>
          <button class="sort-option" data-key="d" data-label="D">
            <span class="color-dot d"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">D</span>
              <span class="sort-option-sub">Pwd Delta</span>
            </span>
          </button>
          <button class="sort-option" data-key="f" data-label="F">
            <span class="color-dot f"></span>
            <span class="sort-option-label-main">
              <span class="sort-option-title">F</span>
              <span class="sort-option-sub">Flanergide</span>
            </span>
          </button>
        </div>
      </div>

      <div class="btn-group sort-toggle" role="group" aria-label="Sort direction">
        <button type="button" class="btn btn-sm" data-dir="desc" id="sort-dir-desc">High ‚Üí Low</button>
        <button type="button" class="btn btn-sm active" data-dir="asc" id="sort-dir-asc">Low ‚Üí High</button>
      </div>

      <div class="result-count ms-md-1 mt-1 mt-md-0" id="result-count"></div>
    </div>
  </div>

  <div class="mb-3">
    <div class="caps mb-2">Quick picks</div>
    <div class="d-flex flex-wrap gap-2" id="quick-picks"></div>
  </div>

  <div id="results" class="row g-3"></div>

  <footer class="mt-4 text-center text-secondary small">
    Data is loaded from <code>drinks.json</code>.
  </footer>
</div>

<script>
  let DRINKS = [];

  const searchInput   = document.getElementById('search-input');
  const resultsEl     = document.getElementById('results');
  const resultCountEl = document.getElementById('result-count');
  const queryLabelEl  = document.getElementById('query-label');
  const quickPicksEl  = document.getElementById('quick-picks');

  const sortDropdown       = document.getElementById('sort-dropdown');
  const sortDropdownToggle = document.getElementById('sort-dropdown-toggle');
  const sortMenu           = document.getElementById('sort-menu');
  const sortCurrentLabel   = document.getElementById('sort-current-label');
  const sortDirDesc        = document.getElementById('sort-dir-desc');
  const sortDirAsc         = document.getElementById('sort-dir-asc');

  let currentSortKey = 'name';
  let currentSortDir = 'asc';

  function normalizeFlagWithOpt(v) {
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (s === 'opt' || s === 'optional') return 'opt';
      if (['', '0', 'false', 'no', 'none', 'off'].includes(s)) return 'none';
      return 'req';
    }
    if (typeof v === 'boolean') return v ? 'req' : 'none';
    if (typeof v === 'number') return v ? 'req' : 'none';
    return 'none';
  }

  function normalizeBlend(v) {
    if (typeof v === 'string') {
      const s = v.trim().toLowerCase();
      if (s === 'short' || s === 's') return 'short';
      if (s === 'long'  || s === 'l') return 'long';
      if (s === 'opt'   || s === 'optional') return 'opt';
      return '';
    }
    if (typeof v === 'boolean') return v ? 'short' : '';
    if (typeof v === 'number')  return v ? 'short' : '';
    return '';
  }

  function normalizeDrinks(raw) {
    return raw.map(d => ({
      ...d,
      ice: normalizeFlagWithOpt(d.ice),
      age: normalizeFlagWithOpt(d.age),
      blend: normalizeBlend(d.blend),
    }));
  }

  function matchesQuery(drink, q) {
    if (!q) return true;

    const query = q.toLowerCase();
    const rawName = (drink.name || '').toLowerCase();
    const simple = rawName.replace(/[^a-z0-9]+/g, ' ').trim();
    const compact = simple.replace(/\s+/g, '');
    const tokens = simple.split(/\s+/).filter(Boolean);
    const initials = tokens.map(t => t[0]).join('');

    return (
      rawName.includes(query) ||
      simple.includes(query)  ||
      compact.includes(query) ||
      initials.includes(query)
    );
  }

  function getNumStat(d, key) {
    const v = d[key];
    if (v === null || v === undefined || v === '') return -Infinity;
    const n = Number(v);
    return Number.isFinite(n) ? n : -Infinity;
  }

  function getKValue(d) {
    const raw = (d.k ?? '').toString();
    const m = raw.match(/\^?(\d+)/);
    if (!m) return -Infinity;
    const n = Number(m[1]);
    return Number.isFinite(n) ? n : -Infinity;
  }

  function sortDrinks(list) {
    const arr = [...list];
    const dir = currentSortDir === 'asc' ? 1 : -1;

    switch (currentSortKey) {
      case 'a':
        arr.sort((x, y) => dir * (getNumStat(x, 'a') - getNumStat(y, 'a')));
        break;
      case 'b':
        arr.sort((x, y) => dir * (getNumStat(x, 'b') - getNumStat(y, 'b')));
        break;
      case 'd':
        arr.sort((x, y) => dir * (getNumStat(x, 'd') - getNumStat(y, 'd')));
        break;
      case 'f':
        arr.sort((x, y) => dir * (getNumStat(x, 'f') - getNumStat(y, 'f')));
        break;
      case 'k':
        arr.sort((x, y) => dir * (getKValue(x) - getKValue(y)));
        break;
      case 'name':
      default:
        arr.sort((x, y) =>
          dir === 1
            ? (x.name || '').localeCompare(y.name || '')
            : (y.name || '').localeCompare(x.name || '')
        );
        break;
    }
    return arr;
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function renderQuickPicks(list) {
    quickPicksEl.innerHTML = '';
    const max = Math.min(10, list.length);
    for (let i = 0; i < max; i++) {
      const d = list[i];
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'badge rounded-pill bg-secondary text-decoration-none px-3 py-2 quick-pick';
      a.dataset.name = d.name || '';
      a.textContent = d.name || '';
      quickPicksEl.appendChild(a);
    }
  }

  function renderResults(list, query) {
    resultsEl.innerHTML = '';

    const count = list.length;
    if (query) {
      queryLabelEl.textContent = ` for ‚Äú${query}‚Äù`;
    } else {
      queryLabelEl.textContent = '';
    }
    resultCountEl.textContent = count + (count === 1 ? ' match' : ' matches');

    if (count === 0) {
      const div = document.createElement('div');
      div.className = 'alert alert-warning glass border-warning-subtle text-warning-emphasis';
      div.textContent = 'No drinks found with that name. Double-check the spelling against the image.';
      resultsEl.appendChild(div);
      return;
    }

    list.forEach(d => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';

      const name = escapeHtml(d.name || '');
      const altName = escapeHtml(d.alt_name || '');
      const a = d.a !== null && d.a !== undefined ? d.a : '‚Äî';
      const b = d.b !== null && d.b !== undefined ? d.b : '‚Äî';
      const dd = d.d !== null && d.d !== undefined ? d.d : '‚Äî';
      const f = d.f !== null && d.f !== undefined ? d.f : '‚Äî';
      const k = d.k !== null && d.k !== undefined && d.k !== '' ? d.k : '‚Äî';
      const notes = escapeHtml(d.notes || '');

      const iceState   = (d.ice   || 'none').toString().toLowerCase();
      const ageState   = (d.age   || 'none').toString().toLowerCase();
      const blendState = (d.blend || '').toString().toLowerCase();

      const hasIceReq = iceState === 'req';
      const hasIceOpt = iceState === 'opt';
      const hasAgeReq = ageState === 'req';
      const hasAgeOpt = ageState === 'opt';
      const hasBlendShort = blendState === 'short';
      const hasBlendLong  = blendState === 'long';
      const hasBlendOpt   = blendState === 'opt';
      const hasBlend = hasBlendShort || hasBlendLong || hasBlendOpt;

      let flagsHtml = '';

      if (hasIceReq) {
        flagsHtml += '<span class="badge badge-pill bg-info text-dark">üßä Ice</span>';
      }
      if (hasIceOpt) {
        flagsHtml += '<span class="badge badge-pill bg-info text-dark">üßä Ice (opt)</span>';
      }
      if (hasAgeReq) {
        flagsHtml += '<span class="badge badge-pill bg-dark border border-secondary">‚è≥ Aged</span>';
      }
      if (hasAgeOpt) {
        flagsHtml += '<span class="badge badge-pill bg-dark border border-secondary">‚è≥ Aged (opt)</span>';
      }

      if (hasBlendShort) {
        flagsHtml += '<span class="badge badge-pill bg-primary">‚ö° Short blend</span>';
      } else if (hasBlendLong) {
        flagsHtml += '<span class="badge badge-pill bg-primary">‚è± Long blend</span>';
      } else if (hasBlendOpt) {
        flagsHtml += '<span class="badge badge-pill bg-primary">üåÄ Blend (opt)</span>';
      }

      const noFlags = !hasIceReq && !hasIceOpt && !hasAgeReq && !hasAgeOpt && !hasBlend;

      col.innerHTML = `
        <div class="glass drink-card h-100 p-3 border border-0">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h2 class="h5 mb-1">${name}</h2>
              ${altName ? `<div class="text-secondary small">${altName}</div>` : ``}
            </div>
          </div>

          <div class="mb-2">
            <div class="stat-label mb-1">Stats</div>
            <div class="d-flex flex-wrap gap-1">
              <div class="badge badge-pill stat-pill pill-a">A: ${a}</div>
              <div class="badge badge-pill stat-pill pill-b">B: ${b}</div>
              <div class="badge badge-pill stat-pill pill-d">D: ${dd}</div>
              <div class="badge badge-pill stat-pill pill-f">F: ${f}</div>
              <div class="badge badge-pill stat-pill pill-k">K: ${k}</div>
            </div>
          </div>

          <div class="mb-2">
            <div class="stat-label mb-1">Flags</div>
            <div class="d-flex flex-wrap gap-1">
              ${noFlags ? '<span class="text-secondary small">No extra flags set for this entry.</span>' : flagsHtml}
            </div>
          </div>

          ${notes ? `<p class="small text-secondary mb-0">${notes}</p>` : ''}
        </div>
      `;

      resultsEl.appendChild(col);
    });
  }

  function updateResults() {
    const qraw = searchInput.value || '';
    const q = qraw.trim().toLowerCase();
    const filtered = DRINKS.filter(d => matchesQuery(d, q));
    const sorted = sortDrinks(filtered);
    renderResults(sorted, qraw.trim());
  }

  sortDropdownToggle.addEventListener('click', () => {
    const isOpen = sortDropdown.classList.contains('open');
    if (isOpen) {
      sortDropdown.classList.remove('open');
    } else {
      sortDropdown.classList.add('open');
    }
  });

  sortMenu.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.sort-option');
    if (!btn) return;

    const key = btn.getAttribute('data-key') || 'name';
    const label = btn.getAttribute('data-label') || 'Default (A ‚Üí Z)';

    currentSortKey = key;
    sortCurrentLabel.textContent = label;

    sortMenu.querySelectorAll('.sort-option').forEach(opt => {
      opt.classList.toggle('active', opt === btn);
    });

    sortDropdown.classList.remove('open');
    updateResults();
  });

  document.addEventListener('click', (ev) => {
    if (!sortDropdown.contains(ev.target)) {
      sortDropdown.classList.remove('open');
    }
  });

  sortDirDesc.addEventListener('click', () => {
    currentSortDir = 'desc';
    sortDirDesc.classList.add('active');
    sortDirAsc.classList.remove('active');
    updateResults();
  });

  sortDirAsc.addEventListener('click', () => {
    currentSortDir = 'asc';
    sortDirAsc.classList.add('active');
    sortDirDesc.classList.remove('active');
    updateResults();
  });

  searchInput.addEventListener('input', updateResults);

  if (quickPicksEl) {
    quickPicksEl.addEventListener('click', (ev) => {
      const target = ev.target.closest('.quick-pick');
      if (!target) return;
      ev.preventDefault();
      const name = target.getAttribute('data-name') || '';
      searchInput.value = name;
      updateResults();
      searchInput.focus();
    });
  }

  fetch('drinks.json')
    .then(resp => {
      if (!resp.ok) throw new Error('Failed to load drinks.json');
      return resp.json();
    })
    .then(data => {
      DRINKS = normalizeDrinks(data);
      renderQuickPicks(DRINKS);
      updateResults();
    })
    .catch(err => {
      console.error(err);
      resultsEl.innerHTML = '<div class="alert alert-danger">Failed to load drinks.json. Check the file location and GitHub Pages settings.</div>';
      resultCountEl.textContent = '';
    });
</script>
</body>
</html>
